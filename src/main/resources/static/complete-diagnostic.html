<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Diagnostic - FoodFast</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        .subtitle {
            color: #6c757d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        .section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        .section h2 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-box {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .icon {
            font-size: 24px;
            font-weight: bold;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .card-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        .card-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .progress {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Complete System Diagnostic</h1>
        <p class="subtitle">Ki·ªÉm tra to√†n di·ªán h·ªá th·ªëng Store Management</p>

        <!-- Overall Progress -->
        <div class="progress">
            <div class="progress-bar" id="overallProgress" style="width: 0%">0%</div>
        </div>

        <!-- Quick Stats -->
        <div class="grid" id="statsGrid">
            <div class="card">
                <div class="card-label">Tests Run</div>
                <div class="card-value" id="testsRun">0</div>
            </div>
            <div class="card">
                <div class="card-label">Passed</div>
                <div class="card-value" style="color: #28a745;" id="testsPassed">0</div>
            </div>
            <div class="card">
                <div class="card-label">Failed</div>
                <div class="card-value" style="color: #dc3545;" id="testsFailed">0</div>
            </div>
            <div class="card">
                <div class="card-label">Warnings</div>
                <div class="card-value" style="color: #ffc107;" id="testsWarnings">0</div>
            </div>
        </div>

        <!-- Test Results -->
        <div id="results"></div>

        <!-- Actions -->
        <div class="actions">
            <button class="btn-primary" onclick="runAllTests()">
                <span class="loading" id="runningIndicator" style="display: none;"></span>
                üîÑ Run All Tests
            </button>
            <button class="btn-success" onclick="window.location.href='store-management.html'">
                üè™ Go to Store Management
            </button>
            <button class="btn-warning" onclick="clearAndReload()">
                üóëÔ∏è Clear Cache & Reload
            </button>
            <button class="btn-danger" onclick="resetEverything()">
                üí£ Reset Everything
            </button>
        </div>

        <!-- Console Logs -->
        <div class="section">
            <h2>üìã Console Logs</h2>
            <pre id="consoleLogs"></pre>
            <button class="btn-primary" onclick="clearConsoleLogs()">Clear Logs</button>
        </div>
    </div>

    <script>
        // Capture console logs
        const logs = [];
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            logs.push('[LOG] ' + args.join(' '));
            updateConsoleLogs();
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            logs.push('[ERROR] ' + args.join(' '));
            updateConsoleLogs();
            originalError.apply(console, args);
        };

        console.warn = function(...args) {
            logs.push('[WARN] ' + args.join(' '));
            updateConsoleLogs();
            originalWarn.apply(console, args);
        };

        function updateConsoleLogs() {
            const logsDiv = document.getElementById('consoleLogs');
            logsDiv.textContent = logs.slice(-50).join('\n'); // Last 50 logs
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearConsoleLogs() {
            logs.length = 0;
            updateConsoleLogs();
        }

        // Test statistics
        let stats = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0
        };

        function updateStats() {
            document.getElementById('testsRun').textContent = stats.total;
            document.getElementById('testsPassed').textContent = stats.passed;
            document.getElementById('testsFailed').textContent = stats.failed;
            document.getElementById('testsWarnings').textContent = stats.warnings;

            const progress = stats.total > 0 ? Math.round((stats.passed / stats.total) * 100) : 0;
            const progressBar = document.getElementById('overallProgress');
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
        }

        // Test functions
        async function runAllTests() {
            const resultsDiv = document.getElementById('results');
            const runningIndicator = document.getElementById('runningIndicator');

            runningIndicator.style.display = 'inline-block';
            resultsDiv.innerHTML = '<div class="status-box info"><span class="icon">‚è≥</span> Running tests...</div>';

            stats = { total: 0, passed: 0, failed: 0, warnings: 0 };

            let html = '';

            // Test 1: Storage Keys
            html += await testStorageKeys();

            // Test 2: Authentication
            html += await testAuthentication();

            // Test 3: LocalStorage Data
            html += await testLocalStorage();

            // Test 4: DOM Elements
            html += await testDOMElements();

            // Test 5: Scripts Loading
            html += await testScriptsLoading();

            // Test 6: API Connectivity
            html += await testAPIConnectivity();

            // Test 7: Store Management Specific
            html += await testStoreManagement();

            resultsDiv.innerHTML = html;
            runningIndicator.style.display = 'none';
            updateStats();

            // Show summary
            showSummary();
        }

        async function testStorageKeys() {
            const testName = 'Storage Keys Check';
            console.log(`\n=== ${testName} ===`);

            let html = `<div class="section"><h2>üîë ${testName}</h2>`;
            stats.total++;

            try {
                // Check if STORAGE_KEYS is defined
                if (typeof STORAGE_KEYS !== 'undefined') {
                    html += `<div class="status-box success"><span class="icon">‚úÖ</span> STORAGE_KEYS is defined</div>`;
                    html += `<pre>${JSON.stringify(STORAGE_KEYS, null, 2)}</pre>`;

                    // Check keys
                    if (STORAGE_KEYS.TOKEN === 'foodfast_token' && STORAGE_KEYS.USER === 'foodfast_user') {
                        html += `<div class="status-box success"><span class="icon">‚úÖ</span> Keys are correct</div>`;
                        stats.passed++;
                    } else {
                        html += `<div class="status-box error"><span class="icon">‚ùå</span> Keys are incorrect!</div>`;
                        stats.failed++;
                    }
                } else {
                    html += `<div class="status-box error"><span class="icon">‚ùå</span> STORAGE_KEYS is NOT defined</div>`;
                    html += `<div class="status-box warning"><span class="icon">‚ö†Ô∏è</span> This means scripts haven't loaded yet or there's an error</div>`;
                    stats.failed++;
                }
            } catch (e) {
                html += `<div class="status-box error"><span class="icon">‚ùå</span> Error: ${e.message}</div>`;
                stats.failed++;
            }

            html += '</div>';
            return html;
        }

        async function testAuthentication() {
            const testName = 'Authentication Status';
            console.log(`\n=== ${testName} ===`);

            let html = `<div class="section"><h2>üîê ${testName}</h2>`;
            stats.total++;

            const token = localStorage.getItem('foodfast_token');
            const userData = localStorage.getItem('foodfast_user');

            if (token && userData) {
                html += `<div class="status-box success"><span class="icon">‚úÖ</span> User is authenticated</div>`;

                try {
                    const user = JSON.parse(userData);
                    html += `<div class="status-box success"><span class="icon">‚úÖ</span> User ID: ${user.id}</div>`;
                    html += `<div class="status-box success"><span class="icon">‚úÖ</span> Username: ${user.username || user.email || 'N/A'}</div>`;
                    html += `<pre>${JSON.stringify(user, null, 2)}</pre>`;
                    stats.passed++;
                } catch (e) {
                    html += `<div class="status-box error"><span class="icon">‚ùå</span> User data is invalid JSON</div>`;
                    stats.failed++;
                }
            } else {
                html += `<div class="status-box error"><span class="icon">‚ùå</span> User is NOT authenticated</div>`;
                if (!token) html += `<div class="status-box error"><span class="icon">‚ùå</span> Token missing</div>`;
                if (!userData) html += `<div class="status-box error"><span class="icon">‚ùå</span> User data missing</div>`;
                html += `<div class="status-box warning"><span class="icon">‚ö†Ô∏è</span> Please login at index.html</div>`;
                stats.failed++;
            }

            html += '</div>';
            return html;
        }

        async function testLocalStorage() {
            const testName = 'LocalStorage Inspection';
            console.log(`\n=== ${testName} ===`);

            let html = `<div class="section"><h2>üíæ ${testName}</h2>`;
            stats.total++;

            const keys = Object.keys(localStorage);
            html += `<div class="status-box info"><span class="icon">üì¶</span> Total items: ${keys.length}</div>`;

            if (keys.length > 0) {
                html += '<pre>';
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    const preview = value.length > 100 ? value.substring(0, 100) + '...' : value;
                    html += `${key}: ${preview}\n`;
                });
                html += '</pre>';
                stats.passed++;
            } else {
                html += `<div class="status-box warning"><span class="icon">‚ö†Ô∏è</span> LocalStorage is empty</div>`;
                stats.warnings++;
            }

            html += '</div>';
            return html;
        }

        async function testDOMElements() {
            const testName = 'DOM Elements Check';
            console.log(`\n=== ${testName} ===`);

            let html = `<div class="section"><h2>üéØ ${testName}</h2>`;
            stats.total++;

            // Create hidden iframe to test store-management.html
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = 'store-management.html';

            return new Promise((resolve) => {
                iframe.onload = function() {
                    try {
                        const doc = iframe.contentDocument || iframe.contentWindow.document;

                        const elements = {
                            'userName': doc.getElementById('userName'),
                            'storeSelect': doc.getElementById('storeSelect'),
                            'userDropdown': doc.getElementById('userDropdown'),
                            'dropdownMenu': doc.getElementById('dropdownMenu'),
                            'storeContent': doc.getElementById('storeContent'),
                            'createStoreModal': doc.getElementById('createStoreModal')
                        };

                        let allFound = true;
                        Object.entries(elements).forEach(([name, element]) => {
                            if (element) {
                                html += `<div class="status-box success"><span class="icon">‚úÖ</span> #${name} found</div>`;
                            } else {
                                html += `<div class="status-box error"><span class="icon">‚ùå</span> #${name} NOT found</div>`;
                                allFound = false;
                            }
                        });

                        if (allFound) {
                            stats.passed++;
                        } else {
                            stats.failed++;
                        }

                        document.body.removeChild(iframe);
                    } catch (e) {
                        html += `<div class="status-box error"><span class="icon">‚ùå</span> Cannot access iframe: ${e.message}</div>`;
                        stats.failed++;
                        if (iframe.parentNode) document.body.removeChild(iframe);
                    }

                    html += '</div>';
                    resolve(html);
                };

                iframe.onerror = function() {
                    html += `<div class="status-box error"><span class="icon">‚ùå</span> Failed to load store-management.html</div>`;
                    stats.failed++;
                    if (iframe.parentNode) document.body.removeChild(iframe);
                    html += '</div>';
                    resolve(html);
                };

                document.body.appendChild(iframe);
            });
        }

        async function testScriptsLoading() {
            const testName = 'Scripts Loading Check';
            console.log(`\n=== ${testName} ===`);

            let html = `<div class="section"><h2>üìú ${testName}</h2>`;
            stats.total++;

            const scripts = ['config.js', 'auth.js', 'store-management.js'];
            let allLoaded = true;

            for (const scriptName of scripts) {
                const scriptElements = Array.from(document.getElementsByTagName('script'));
                const found = scriptElements.some(s => s.src.includes(scriptName));

                if (found || scriptName === 'store-management.js') {
                    html += `<div class="status-box success"><span class="icon">‚úÖ</span> ${scriptName} loaded</div>`;
                } else {
                    html += `<div class="status-box warning"><span class="icon">‚ö†Ô∏è</span> ${scriptName} not loaded here (may be in other pages)</div>`;
                    allLoaded = false;
                }
            }

            if (allLoaded) {
                stats.passed++;
            } else {
                stats.warnings++;
            }

            html += '</div>';
            return html;
        }

        async function testAPIConnectivity() {
            const testName = 'API Connectivity';
            console.log(`\n=== ${testName} ===`);

            let html = `<div class="section"><h2>üîå ${testName}</h2>`;
            stats.total++;

            const token = localStorage.getItem('foodfast_token');
            const userData = localStorage.getItem('foodfast_user');

            if (!token || !userData) {
                html += `<div class="status-box warning"><span class="icon">‚ö†Ô∏è</span> Skipping API test - not authenticated</div>`;
                stats.warnings++;
                html += '</div>';
                return html;
            }

            try {
                const user = JSON.parse(userData);
                const userId = user.id;

                // Test stores API
                const response = await fetch(`http://localhost:8080/home/api/stores/owner/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                html += `<div class="status-box info"><span class="icon">üì°</span> API Response Status: ${response.status}</div>`;

                if (response.ok) {
                    const data = await response.json();
                    html += `<div class="status-box success"><span class="icon">‚úÖ</span> API is accessible</div>`;
                    html += `<div class="status-box info"><span class="icon">üè™</span> User has ${data.result ? data.result.length : 0} store(s)</div>`;
                    html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    stats.passed++;
                } else {
                    const errorData = await response.json();
                    html += `<div class="status-box error"><span class="icon">‚ùå</span> API returned error</div>`;
                    html += `<pre>${JSON.stringify(errorData, null, 2)}</pre>`;
                    stats.failed++;
                }
            } catch (e) {
                html += `<div class="status-box error"><span class="icon">‚ùå</span> API Error: ${e.message}</div>`;
                stats.failed++;
            }

            html += '</div>';
            return html;
        }

        async function testStoreManagement() {
            const testName = 'Store Management Specific';
            console.log(`\n=== ${testName} ===`);

            let html = `<div class="section"><h2>üè™ ${testName}</h2>`;
            stats.total++;

            // Check if functions exist
            const functions = ['checkAuth', 'loadUserStores', 'toggleDropdown', 'logout'];
            let allExist = true;

            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    html += `<div class="status-box success"><span class="icon">‚úÖ</span> ${funcName}() exists</div>`;
                } else {
                    html += `<div class="status-box error"><span class="icon">‚ùå</span> ${funcName}() NOT found</div>`;
                    allExist = false;
                }
            });

            if (allExist) {
                stats.passed++;
            } else {
                stats.failed++;
            }

            html += '</div>';
            return html;
        }

        function showSummary() {
            const resultsDiv = document.getElementById('results');

            let summaryHtml = '<div class="section" style="border-left-color: ';

            if (stats.failed === 0) {
                summaryHtml += '#28a745;"><h2>üéâ All Tests Passed!</h2>';
                summaryHtml += `<div class="status-box success"><span class="icon">‚úÖ</span> ${stats.passed}/${stats.total} tests passed</div>`;
                if (stats.warnings > 0) {
                    summaryHtml += `<div class="status-box warning"><span class="icon">‚ö†Ô∏è</span> ${stats.warnings} warning(s)</div>`;
                }
                summaryHtml += `<div class="status-box info"><span class="icon">üöÄ</span> You can now use Store Management!</div>`;
                summaryHtml += `<button class="btn-success" onclick="window.location.href='store-management.html'" style="margin-top: 15px;">Go to Store Management ‚Üí</button>`;
            } else {
                summaryHtml += '#dc3545;"><h2>‚ùå Some Tests Failed</h2>';
                summaryHtml += `<div class="status-box error"><span class="icon">‚ùå</span> ${stats.failed} test(s) failed</div>`;
                summaryHtml += `<div class="status-box success"><span class="icon">‚úÖ</span> ${stats.passed} test(s) passed</div>`;
                if (stats.warnings > 0) {
                    summaryHtml += `<div class="status-box warning"><span class="icon">‚ö†Ô∏è</span> ${stats.warnings} warning(s)</div>`;
                }
                summaryHtml += `<div class="status-box info"><span class="icon">üí°</span> Please fix the failed tests before using Store Management</div>`;
                summaryHtml += `<div class="status-box info"><span class="icon">üìù</span> Common fixes:</div>`;
                summaryHtml += `<ul style="margin-left: 40px; margin-top: 10px;">`;
                summaryHtml += `<li>If "not authenticated" ‚Üí Go to index.html and login</li>`;
                summaryHtml += `<li>If "STORAGE_KEYS not defined" ‚Üí Clear cache (Ctrl+Shift+R)</li>`;
                summaryHtml += `<li>If "API error" ‚Üí Check if backend server is running</li>`;
                summaryHtml += `<li>If "elements not found" ‚Üí Check store-management.html file</li>`;
                summaryHtml += `</ul>`;
            }

            summaryHtml += '</div>';
            resultsDiv.innerHTML = summaryHtml + resultsDiv.innerHTML;
        }

        function clearAndReload() {
            if (confirm('This will clear browser cache and reload. Continue?')) {
                // Clear caches
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                // Hard reload
                window.location.reload(true);
            }
        }

        function resetEverything() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL data including login session!\n\nAre you sure?')) {
                localStorage.clear();
                sessionStorage.clear();
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => caches.delete(name));
                    });
                }
                alert('All data cleared! Redirecting to login...');
                window.location.href = 'index.html';
            }
        }

        // Auto-run on load
        window.onload = function() {
            setTimeout(() => {
                runAllTests();
            }, 500);
        };
    </script>
</body>
</html>

